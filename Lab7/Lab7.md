Цели
====

Получить практические навыки разработки сервисов (started и bound) и
Broadcast Receivers.

Задачи
======

Задача 1. Started сервис для скачивания изображения
---------------------------------------------------

### Задание

На основе кода из предыдущей лабораторной работы разработать started
service, скачивающий файл из интернета. URL изображения для скачивания
должен передаваться в Intent. Также необходимо убедиться (и описать
доказательство), что код для скачивания исполняется не в UI потоке

Добавить в разработанный сервис функцию отправки broadcast-сообщения по
завершении скачивания. Сообщение (Intent) должно содержать путь к
скачанному файлу.

### Решение

При обработке нажатия на кнопку загрузки изображения в Activity1
производится запуск IntentService, в качестве аргументов Intent-у
передается URL картинки для скачивания:

![image](https://user-images.githubusercontent.com/43096732/114695170-faad2700-9d23-11eb-88dd-513cfa23afd6.png)

Рисунок 1 onClickListener кнопки загрузки

Далее в отдельном потоке начинает исполнение кода из onHandleIntent
IntentService. При успешной загрузке формируется broadcast-сообщение о
загрузке. При этом в Intent добавляется путь к загруженному изображению
на SD-карте.

![image](https://user-images.githubusercontent.com/43096732/114694857-a5711580-9d23-11eb-9b69-76f269ffb462.png)

Рисунок 2 IntentService.kt

На следующем этапе вступает в дело BroadcastReciever, который принимает
broadcast-сообщение и формирует intent для перезапуска текущей Activity:

![image](https://user-images.githubusercontent.com/43096732/114694892-adc95080-9d23-11eb-9c2e-f943180b8553.png)

Рисунок 3 BroadcastReciever

Затем при пересоздании Activity происходит переход по условию (path !=
null), после чего по полученному пути производится загрузка изображения
на экран. По уничтожении Activity происходит отписка от рассылки.

![image](https://user-images.githubusercontent.com/43096732/114694913-b3269b00-9d23-11eb-9f69-aa4e18ed9960.png)

Рисунок 4 Activity1.kt

В Logcat выводятся сообщения о потоках, в которых выполняются задачи.
Здесь можно убедиться, что IntentService выделяет отдельный поток для
выполнения кода. Сервис активируется, когда необходимо, поочередно
обрабатывает все Intent-ы (если их много), после чего закрывается, если
новых Intent-ов не поступало.

![image](https://user-images.githubusercontent.com/43096732/114694957-bde13000-9d23-11eb-8aad-ce82515185e1.png)

Рисунок 5 Вывод Logcat

Задача 2. Broadcast Receiver
----------------------------

### Задание

Разработать два приложения:

-   Первое приложение содержит 1 activity с 1 кнопкой, при нажатии на
    которую запускается сервис по скачиванию файла;

-   Второе приложение содержит 1 broadcast receiver и 1 activity.
    Broadcast receiver по получении сообщения из сервиса инициирует
    отображение *пути* к изображению в TextView в Activity.

### Решение

Фактически решение данной задачи описано в предыдущем пункте. Отметим
основные изменения:

-   Теперь broadcast-сообщение ловится из другого приложения, а не
    просто отдельной Activity;

-   Вместо самой картинки на вывод отправляется путь к ней в
    файловой системе.

В качестве приложения с сервисом для скачивания и отправителя
широковещательных сообщений используем разработанную ранее Activity1.
Теперь напишем второе приложение, которое станет принимать
broadcast-сообщения:

![image](https://user-images.githubusercontent.com/43096732/114694983-c46fa780-9d23-11eb-8638-7482e3847fab.png)

Рисунок 6 MainActivity.kt

Логика работы аналогична таковой для приложения, разработанного в
предыдущем пункте.

Задача 3. Bound Service для скачивания изображения
--------------------------------------------------

### Задание

Сделать разработанный сервис одновременно bound и started:
переопределить метод onBind. Из тела метода возвращать IBinder,
полученный из
класса [Messenger](https://developer.android.com/guide/components/bound-services?hl=ru#Messenger).
Убедиться (доказательство привести в отчете), что код скачивания файла
исполняется не в UI потоке.

Изменить способ запуска сервиса в первом приложении:
вместо startService использовать bindService. При нажатии на кнопку
отправлять
сообщение [Message](https://developer.android.com/reference/android/os/Message.html?hl=ru),
используя класс Messenger, полученный из интерфейса IBinder в
методе [onServiceConnected](https://developer.android.com/reference/android/content/ServiceConnection.html?hl=ru#onServiceConnected(android.content.ComponentName,%20android.os.IBinder)).

Добавить в первое приложение TextView, а в сервис –
отправку [обратного](https://developer.android.com/reference/android/os/Message.html?hl=ru#replyTo) сообщения
с местоположением скачанного файла. При получении сообщения от сервиса
приложение должно отобразить путь к файлу на экране.

Разработанный сервис должен быть одновременно bound и started. Если
получен intent через механизм started service, то сервис скачивает файл
и отправляет broadcast (started service не знает своих клиентов и не
предназначен для двухсторонней коммуникации). Если получен message через
механизм bound service, то скачивается файл и результат отправляется
тому клиенту, который запросил этот файл (т.к. bound service знает всех
своих клиентов и может им отвечать).

### Решение

Перепишем обработчик нажатия кнопки в Activity3:

![image](https://user-images.githubusercontent.com/43096732/114695008-ccc7e280-9d23-11eb-8315-b646914b5fdc.png)

Рисунок 7 Activity3.kt

При необходимости по нажатию на кнопку происходит привязка к сервису.

Если же клиент уже подключен к сервису, через sendRequest() посылается
запрос на скачивание картинки. В Message передается адрес возврата, флаг
запроса и URL изображения, упакованный в Bundle. При наличии ненулевого пути
к файлу картинки он отображается в TextView.

Объект ServiceConnection имеет следующий вид:

![image](https://user-images.githubusercontent.com/43096732/114695028-d18c9680-9d23-11eb-9578-74fa44c0d271.png)

Рисунок 8 ServiceConnection

Также написан обработчик ответа сервера:

![image](https://user-images.githubusercontent.com/43096732/114695045-d5b8b400-9d23-11eb-8702-0894b3e97648.png)

Рисунок 9 OncomingHandler

В обработчике переопределен метод handleMessage: теперь по интересующему
нас флагу устанавливается новое значение переменной, содержащей путь к
загруженной картинке.

К разработанному в приложении 1 сервису добавились переопределенные
функции onBind и HandleMessage:

![image](https://user-images.githubusercontent.com/43096732/114695066-db15fe80-9d23-11eb-84b6-c0c5b0fd9948.png)

Рисунок 10 onBind и HandleMessage

Метод onBind вызывается для первого подключившегося клиента. Далее
запросы от разработанного клиента к серверу организуются в очередь к
IncomingHandler(). Обработчик сообщений проверяет флаг, после чего в
отдельной корутине загружает картинку, кладет адрес полученного файла в
Bundle и отправляет клиенту, воспользовавшись обратным адресом в поле
replyTo. Затем Message обрабатывается на стороне клиента.

В ходе выполнения работы также было проверено, что задача скачивания
изображения вынесена в отдельный поток:

![image](https://user-images.githubusercontent.com/43096732/114695083-dfdab280-9d23-11eb-94aa-a1aa50f59204.png)

Рисунок 11 Вывод в Logcat

Выводы
======

В ходе выполнения лабораторной работы на примере IntentService
исследованы сервисы и методы взаимодействия с ними. Рассмотрены основные
виды сервисов (started-сервисы и bound-сервисы), отработаны механизмы
пересылки данных между элементами Context. Также изучен принцип
организации работы класса Messenger, облегчающий реализацию
взаимодействия с bound-сервисами.

Получены практические навыки разработки Broadcast Receivers — изучен
механизм отправки broadcast-сообщений с помощью метода sendBroadcast,
представляемое классом BroadcastReceiver API для реализации компонентов
приложения, которые способны принимать и обрабатывать
broadcast-сообщения, и необходимые для регистрации Broadcast Receivers в
системе действия.
